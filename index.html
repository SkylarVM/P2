<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Penguin Companion — XP Planner</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <!-- ===== Header ===== -->
  <header class="topbar">
    <div class="brand">
      <span class="emoji">🐧</span>
      <h1>Penguin Companion — XP Planner</h1>
    </div>

    <div class="progress-wrap">
      <div id="levelLine">Level <span id="level">1</span> • XP <span id="xpTotal">0.00</span> • Coins <span id="coinsTotal">0</span></div>
      <div class="xpbar"><div id="xpBar"></div></div>
    </div>

    <div class="top-actions">
      <button id="raceBtn" class="btn ghost">🏁 Race</button>
      <button id="exportJSON" class="btn ghost">Export JSON</button>
      <button id="exportCSV"  class="btn ghost">Export CSV</button>
      <label class="btn ghost file">
        Import <input id="importFile" type="file" accept=".json" />
      </label>
      <button id="openSettings" class="btn ghost">⚙️ Settings</button>
    </div>
  </header>

  <!-- ===== Main Grid ===== -->
  <main class="grid">
    <!-- Tasks -->
    <section class="card" id="tasksCard">
      <h2>✅ To-Do List</h2>
      <div class="row">
        <input id="taskName" type="text" placeholder="New task..."/>
        <select id="taskCategory"></select>
        <input id="taskXP" type="number" min="0.25" step="0.25" placeholder="XP"/>
        <button id="addTask" class="btn">Add Task</button>
        <button id="addCategory" class="btn ghost">+ Add Category</button>
      </div>
      <ul id="taskList" class="list"></ul>
    </section>

    <!-- Rewards -->
    <section class="card">
      <h2>🎁 Reward Store</h2>
      <div class="row">
        <input id="rewardName" type="text" placeholder="New reward..."/>
        <input id="rewardCost" type="number" min="0.25" step="0.25" placeholder="Cost XP"/>
        <button id="addReward" class="btn">Add</button>
      </div>
      <ul id="rewardList" class="list"></ul>
    </section>

    <!-- History -->
    <section class="card">
      <h2>📅 History (Today)</h2>
      <p id="historySummary" class="muted">Total: 0 Pomodoro(s) • 0 XP earned</p>
      <ul id="historyList" class="list slim"></ul>
    </section>

    <!-- Category Stats -->
    <section class="card">
      <h2>📊 Category Stats</h2>
      <div id="statsChart"></div>
    </section>

    <!-- Pomodoro & Calls -->
    <section class="card">
      <h2>⏱️ Pomodoro & 📞 Calls</h2>
      <div class="row compact">
        <label>Focus <input id="focusMin" type="number" min="1" step="1" value="25"/></label>
        <label>Short <input id="shortMin" type="number" min="1" step="1" value="5"/></label>
        <label>Long <input id="longMin" type="number" min="1" step="1" value="15"/></label>
        <button id="savePomo" class="btn ghost">Save</button>
      </div>

      <div class="row wrap">
        <button id="callPenguin" class="btn">🎥 Call Penguin</button>
        <button data-mode="Study"   class="btn ghost callMode">Study</button>
        <button data-mode="Exercise"class="btn ghost callMode">Exercise</button>
        <button data-mode="Eat"     class="btn ghost callMode">Eat</button>
        <button data-mode="Bath"    class="btn ghost callMode">Bath</button>
        <button data-mode="Sleep"   class="btn ghost callMode">Sleep</button>
        <button id="openPomo" class="btn success">🍅 Open Pomodoro</button>
      </div>

      <div class="row">
        <button id="meetBtn" class="btn ghost">🟣 Share call (Meet)</button>
      </div>

      <p class="muted small">Ambient Lab hum is muted by default. Toggle & volume available in full-screen overlays.</p>
    </section>

    <!-- Tools -->
    <section class="card">
      <h2>🧮 & 🔎 Tools</h2>
      <div class="row">
        <button id="openCalc" class="btn">Open Calculator</button>
        <button id="openQuick" class="btn">Open Quick Search</button>
      </div>
      <p class="muted small">Both open as pop-ups so you can keep working.</p>
    </section>

    <!-- Alarms -->
    <section class="card">
      <h2>⏰ Alarms</h2>
      <div class="row compact">
        <input id="alarmTime" type="time"/>
        <input id="alarmLabel" type="text" placeholder="Go to class"/>
        <select id="alarmSound">
          <option>Penguin Beep-Boo</option>
          <option>Soft Bell</option>
          <option>Retro Ping</option>
        </select>
        <button id="addAlarm" class="btn">Add</button>
      </div>
      <ul id="alarmList" class="list slim"></ul>
    </section>

    <!-- Time-Blocking -->
    <section class="card wide">
      <h2>📅 Time-Blocking (15-min)</h2>
      <div class="row compact">
        <input id="blockTitle" type="text" placeholder="Block title"/>
        <input id="blockFrom" type="time" />
        <input id="blockTo"   type="time" />
        <button id="addBlock" class="btn">Add</button>
        <button id="addFromTasks" class="btn ghost">📝 Add from Tasks</button>
        <button id="clearSchedule" class="btn danger ghost">🧹 Clear Schedule</button>
        <button id="clearHistoryToday" class="btn ghost">🗑️ Clear Today’s History</button>
      </div>
      <div class="timeline" id="timeline">
        <div class="now" id="timelineNow">🐧</div>
        <!-- blocks will be rendered here -->
      </div>
      <p class="muted small">Click a block to edit or delete. The penguin marks the current time.</p>
    </section>

    <!-- Avatar Builder (replaces your old avatar area 1:1) -->
    <section class="card">
      <h2>🐧 My Penguin</h2>
      <div class="avatar-wrap">
        <div id="penguinPreview" class="penguin">
          <div class="body"></div><div class="wing left"></div><div class="wing right"></div>
          <div class="eye left"></div><div class="eye right"></div><div class="beak"></div>
        </div>
        <div class="avatar-text">
          <div class="title">Hi, I’m <span id="avatarName">Pingu</span>!</div>
          <div class="muted">I’ll cheer you on in popups & calls.</div>
        </div>
      </div>

      <input id="avatarInput" type="text" placeholder="Pingu"/>
      <div class="chips" id="colorChips">
        <button class="chip" data-color="#3b82f6">Blue</button>
        <button class="chip" data-color="#ef4444">Red</button>
        <button class="chip" data-color="#22c55e">Green</button>
        <button class="chip" data-color="#a855f7">Purple</button>
        <button class="chip" data-color="#f59e0b">Gold</button>
      </div>

      <div class="row">
        <label>Head:
          <select id="headSelect">
            <option value="">none</option>
            <option value="beanie">Beanie</option>
            <option value="crown">Crown</option>
            <option value="gradcap">Graduation Cap</option>
            <option value="bunny">Bunny Ears</option>
            <option value="santa">Santa Hat</option>
          </select>
        </label>
        <label>Body:
          <select id="bodySelect">
            <option value="">none</option>
            <option value="scarf">Scarf</option>
            <option value="hoodie">Hoodie</option>
            <option value="backpack">Backpack</option>
            <option value="cape">Cape</option>
          </select>
        </label>
      </div>

      <label>Effect:
        <select id="effectSelect">
          <option value="">none</option>
          <option value="aura">Aura</option>
          <option value="rainbow">Rainbow Aura</option>
          <option value="frost">Frost Aura</option>
          <option value="shadow">Shadow</option>
        </select>
      </label>

      <button id="saveAvatar" class="btn primary wide">Save Avatar</button>
    </section>

    <!-- Shop -->
    <section class="card">
      <h2>🛍️ Penguin Shop</h2>
      <div class="muted small">Coins: <span id="coinsShop">0</span> • Owned accessories: <span id="ownedCount">0</span></div>
      <div class="shop-columns">
        <div>
          <h3>Accessories</h3>
          <div id="shopAccessories" class="shop"></div>
        </div>
        <div>
          <h3>Themes</h3>
          <div id="shopThemes" class="shop"></div>
        </div>
        <div>
          <h3>Effects</h3>
          <div id="shopEffects" class="shop"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Overlays / Modals ===== -->

  <!-- Pomodoro Overlay (also used by Call) -->
  <div id="pomoOverlay" class="overlay hidden">
    <div class="pomo">
      <div class="pomo-header">
        <div class="pomo-title" id="pomoTitle">🍅 Focus</div>
        <div class="pomo-actions">
          <label class="muted small"><input id="ambientToggle" type="checkbox"/> Ambient</label>
          <input id="ambientVolume" type="range" min="0" max="1" step="0.01" value="0.5"/>
          <button id="minimizeCall" class="btn ghost">Minimize</button>
          <button id="closePomo" class="btn danger ghost">Close</button>
        </div>
      </div>

      <div class="pomo-stage">
        <div id="pomoPenguin" class="penguin large">
          <div class="body"></div><div class="wing left"></div><div class="wing right"></div>
          <div class="eye left"></div><div class="eye right"></div><div class="beak"></div>
        </div>
      </div>

      <div class="pomo-timer">
        <div id="phaseText" class="muted">Focus</div>
        <div id="timer" class="clock">25:00</div>
      </div>

      <div class="row center">
        <button id="startBtn" class="btn">Start</button>
        <button id="pauseBtn" class="btn ghost">Pause</button>
        <button id="doneBtn" class="btn success">Done</button>
      </div>

      <div class="muted small center" id="callCaption">Tip: Open Pomodoro separately if you want both running.</div>
    </div>
  </div>

  <!-- Floating call window -->
  <div id="callWindow" class="call hidden">
    <div class="call-head">
      <div>📞 Penguin Call</div>
      <div>
        <button id="restoreCall" class="btn ghost">⛶</button>
        <button id="closeCall" class="btn danger ghost">✖</button>
      </div>
    </div>
    <div class="call-body">
      <div id="miniPenguin" class="penguin">
        <div class="body"></div><div class="wing left"></div><div class="wing right"></div>
        <div class="eye left"></div><div class="eye right"></div><div class="beak"></div>
      </div>
      <div id="miniCaption" class="muted small center">Chilling…</div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Settings</h3>
        <button id="closeSettings" class="btn danger ghost">✖</button>
      </div>

      <div class="grid modal-grid">
        <div>
          <label class="block">Default Theme
            <select id="defaultTheme">
              <option value="tech">Tech Lab</option>
              <option value="arctic">Arctic Base</option>
              <option value="sunset">Sunset Beach</option>
              <option value="midnight">Midnight Purple</option>
            </select>
          </label>
          <label class="block">Work (min) <input id="setFocus" type="number" min="1" step="1"/></label>
          <label class="block">Short Break (min) <input id="setShort" type="number" min="1" step="1"/></label>
          <label class="block">Long Break (min) <input id="setLong" type="number" min="1" step="1"/></label>
          <label class="block"><input id="autoNext" type="checkbox"/> Auto-start next phase</label>
          <label class="block">Default Sound Volume <input id="soundVol" type="range" min="0" max="1" step="0.01"/></label>
        </div>

        <div>
          <label class="block">Language
            <select id="langSelect">
              <option value="en">English</option>
              <option value="es">Español</option>
            </select>
          </label>

          <div class="row wrap">
            <button id="recalcBtn" class="btn ghost">🪙 Recalculate XP & Coins</button>
            <button id="resetToday" class="btn ghost">Reset Today Only</button>
            <button id="clearAll" class="btn danger">Clear All Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Race: Lobby / Create / Join -->
  <div id="raceLobby" class="modal hidden">
    <div class="modal-card">
      <div class="modal-head">
        <h3>🏁 Penguin Race</h3>
        <button id="closeRaceLobby" class="btn danger ghost">✖</button>
      </div>

      <div class="race-choose">
        <div class="race-box">
          <h4>Create Race</h4>
          <p class="muted small">Generate a code and share it with your friends. Everyone will see a **joint** Pomodoro.</p>
          <button id="createRace" class="btn primary">Create</button>
          <div class="muted small" id="createdCodeWrap" style="display:none">Code: <b id="createdCode"></b> <span class="muted"> (copied)</span></div>
        </div>
        <div class="race-box">
          <h4>Join Race</h4>
          <input id="joinCode" type="text" maxlength="6" placeholder="Enter 6-digit code"/>
          <button id="joinRace" class="btn">Join</button>
          <div class="muted small">Creator can start/close the room.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fullscreen Race Room -->
  <div id="raceRoom" class="overlay hidden">
    <div class="race-room">
      <div class="race-top">
        <div class="race-title">🏁 Race — Code <span id="raceCodeLabel"></span></div>
        <div class="race-actions">
          <button id="raceStart" class="btn success">Start Pomodoro</button>
          <button id="raceClose" class="btn danger ghost">Close Room</button>
        </div>
      </div>

      <div class="race-grid">
        <div class="race-left">
          <div id="raceTimer" class="clock big">25:00</div>
          <div id="racePhase" class="muted">Focus</div>
          <div class="row center" id="raceControls">
            <button id="racePause" class="btn ghost">Pause</button>
            <button id="raceDone" class="btn success">Done</button>
          </div>
          <div class="muted small center">When the 5-minute break starts, a mini-game pops up and auto-closes when focus resumes.</div>
        </div>
        <div class="race-right">
          <h4>Participants</h4>
          <ul id="raceUsers" class="list slim"></ul>
          <h4>Leaderboard</h4>
          <ul id="raceBoard" class="list slim"></ul>
        </div>
      </div>
    </div>

    <!-- Mini-games modal inside race -->
    <div id="gameModal" class="modal hidden">
      <div class="modal-card game">
        <div class="modal-head">
          <h3>🎮 Break Mini-Game</h3>
          <span class="muted small" id="gameTimer">05:00</span>
        </div>
        <div id="gameArea" class="game-area"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden">
    <div id="toastPenguin" class="penguin tiny">
      <div class="body"></div><div class="wing left"></div><div class="wing right"></div>
      <div class="eye left"></div><div class="eye right"></div><div class="beak"></div>
    </div>
    <div>
      <div id="toastTitle" class="bold">Pingu</div>
      <div id="toastMsg"   class="muted small">Nice job!</div>
    </div>
  </div>

  <!-- Sounds -->
  <audio id="bell" preload="auto" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>
  <audio id="ambient" preload="auto" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@master/white-noise.ogg" loop></audio>

  <script src="script.js"></script>
</body>
</html>
